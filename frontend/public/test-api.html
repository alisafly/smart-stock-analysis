<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯APIè¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        textarea { width: 100%; height: 300px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 12px; }
        .status-bar { background-color: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 20px; }
        .loading { opacity: 0.7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å‰ç«¯APIè¿æ¥è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å¸®åŠ©è¯Šæ–­å‰ç«¯ä¸åç«¯AIæœåŠ¡çš„è¿æ¥é—®é¢˜</p>
        
        <div class="status-bar">
            <strong>æµ‹è¯•ç¯å¢ƒï¼š</strong>
            <span id="environment">æ£€æµ‹ä¸­...</span> | 
            <strong>åç«¯åœ°å€ï¼š</strong>
            <span id="backend-url">http://localhost:3002/api</span>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button onclick="testAPIConnection()" id="btn-api">ğŸ”— æµ‹è¯•APIè¿æ¥</button>
            <button onclick="testChatAPI()" id="btn-chat">ğŸ’¬ æµ‹è¯•AIèŠå¤©</button>
            <button onclick="testFullWorkflow()" id="btn-full">ğŸš€ å®Œæ•´æµç¨‹æµ‹è¯•</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div id="results"></div>
        
        <h3>ğŸ“‹ è¯¦ç»†æµ‹è¯•æ—¥å¿—ï¼š</h3>
        <textarea id="logs" readonly placeholder="æµ‹è¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹è¿è¡Œç¯å¢ƒ
        const isFromVite = window.location.protocol === 'http:' && window.location.port === '5173';
        const API_BASE_URL = isFromVite ? '/api' : 'http://localhost:3002/api';
        
        let logs = [];
        let isLoading = false;

        // æ›´æ–°ç¯å¢ƒä¿¡æ¯
        document.getElementById('environment').textContent = isFromVite ? 
            'Viteå¼€å‘æœåŠ¡å™¨ (æ¨è)' : 'Fileåè®® (å¯èƒ½æœ‰CORSé—®é¢˜)';
        document.getElementById('backend-url').textContent = API_BASE_URL;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            document.getElementById('logs').value = logs.join('\n');
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
            console.log(logMessage);
        }

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            log(message);
        }

        function setLoading(loading) {
            isLoading = loading;
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = loading;
                btn.classList.toggle('loading', loading);
            });
        }

        async function testAPIConnection() {
            log('å¼€å§‹æµ‹è¯•åŸºç¡€APIè¿æ¥...');
            setLoading(true);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${API_BASE_URL}/chat/status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    addResult('âœ… APIè¿æ¥æˆåŠŸ', 'success');
                    addResult(`AIæä¾›å•†: ${data.aiService.provider}`, 'success');
                    addResult(`AIå¯ç”¨: ${data.aiService.available}`, 'success');
                    addResult(`å½“å‰æ¨¡å‹: ${data.aiService.currentModel}`, 'success');
                    addResult(`æ™ºè°±AIå®¢æˆ·ç«¯: ${data.aiService.clients.zhipu ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, 
                             data.aiService.clients.zhipu ? 'success' : 'error');
                } else {
                    const errorText = await response.text();
                    addResult(`âŒ APIè¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                    log(`å“åº”å†…å®¹: ${errorText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addResult('âŒ APIè¿æ¥è¶…æ—¶ (10ç§’)', 'error');
                } else {
                    addResult(`âŒ APIè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                }
                log(`è¯¦ç»†é”™è¯¯: ${error.stack}`);
                
                // æä¾›è¯Šæ–­å»ºè®®
                if (error.message.includes('Failed to fetch')) {
                    addResult('ğŸ’¡ è¯Šæ–­å»ºè®®: æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3002', 'info');
                    if (!isFromVite) {
                        addResult('ğŸ’¡ å»ºè®®: é€šè¿‡Viteå¼€å‘æœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ (http://localhost:5173/test-api.html)', 'info');
                    }
                }
            } finally {
                setLoading(false);
            }
        }

        async function testChatAPI() {
            log('å¼€å§‹æµ‹è¯•AIèŠå¤©API...');
            setLoading(true);
            
            try {
                const requestBody = {
                    message: "ä½ å¥½ï¼Œè¿™æ˜¯å‰ç«¯è¿æ¥æµ‹è¯•ï¼Œè¯·ç¡®è®¤ä½ ä½¿ç”¨çš„æ˜¯GLM-4.5-Flashæ¨¡å‹",
                    stockContext: null,
                    conversationId: Date.now().toString()
                };

                log(`å‘é€è¯·æ±‚: ${JSON.stringify(requestBody, null, 2)}`);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                log(`æ”¶åˆ°å“åº”çŠ¶æ€: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    addResult('âœ… AIèŠå¤©APIè°ƒç”¨æˆåŠŸ', 'success');
                    addResult(`AIæä¾›å•†: ${data.aiProvider}`, 'success');
                    addResult(`å½“å‰æ¨¡å‹: ${data.aiServiceStatus?.currentModel || 'æœªçŸ¥'}`, 'success');
                    addResult(`å“åº”é•¿åº¦: ${data.response.length} å­—ç¬¦`, 'success');
                    addResult(`å“åº”é¢„è§ˆ: ${data.response.substring(0, 150)}...`, 'info');
                    log(`å®Œæ•´AIå“åº”: ${data.response}`);
                } else {
                    const errorText = await response.text();
                    addResult(`âŒ AIèŠå¤©APIå¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                    log(`é”™è¯¯å“åº”å†…å®¹: ${errorText}`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addResult('âŒ AIèŠå¤©APIè¶…æ—¶ (30ç§’)', 'error');
                } else {
                    addResult(`âŒ AIèŠå¤©APIé”™è¯¯: ${error.message}`, 'error');
                }
                log(`è¯¦ç»†é”™è¯¯: ${error.stack}`);
            } finally {
                setLoading(false);
            }
        }

        async function testFullWorkflow() {
            log('=== å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯• ===');
            addResult('ğŸš€ å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...', 'info');
            
            // 1. æµ‹è¯•APIè¿æ¥
            await testAPIConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. æµ‹è¯•èŠå¤©API
            await testChatAPI();
            
            log('=== å®Œæ•´æµç¨‹æµ‹è¯•ç»“æŸ ===');
            addResult('ğŸ“‹ æµç¨‹æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹ç»“æœ', 'info');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('logs').value = '';
            logs = [];
            log('æµ‹è¯•ç»“æœå·²æ¸…é™¤');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œæµ‹è¯•...');
            if (isFromVite) {
                log('âœ… æ£€æµ‹åˆ°é€šè¿‡Viteå¼€å‘æœåŠ¡å™¨è®¿é—®ï¼ŒCORSé—®é¢˜å·²è§£å†³');
                addResult('âœ… è¿è¡Œç¯å¢ƒ: Viteå¼€å‘æœåŠ¡å™¨ (æ— CORSé—®é¢˜)', 'success');
            } else {
                log('âš ï¸ æ£€æµ‹åˆ°é€šè¿‡file://åè®®è®¿é—®ï¼Œå¯èƒ½å­˜åœ¨CORSé—®é¢˜');
                addResult('âš ï¸ è¿è¡Œç¯å¢ƒ: Fileåè®® (å¯èƒ½æœ‰CORSé™åˆ¶)', 'error');
                addResult('ğŸ’¡ å»ºè®®: è¯·é€šè¿‡ http://localhost:5173 è®¿é—®å‰ç«¯åº”ç”¨', 'info');
            }
            
            // è‡ªåŠ¨å¼€å§‹åŸºç¡€æµ‹è¯•
            setTimeout(() => {
                if (!isLoading) {
                    testAPIConnection();
                }
            }, 1000);
        };
    </script>
</body>
</html>